<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Upload Scan - Stroke Detection System</title>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background-color: #000000;
      color: #FFFFFF;
      margin: 0;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    .header-bar {
      background-color: #F5F5DC;
      border-bottom: 3px solid #FDB927;
      color: #000000;
      padding: 15px 30px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .header-left {
      display: flex;
      align-items: center;
      gap: 20px;
    }

    .system-name {
      font-size: 24px;
      font-weight: bold;
      color: #000000;
    }

    .back-btn {
      background-color: #FDB927;
      color: #000000;
      font-weight: bold;
      padding: 8px 16px;
      border: none;
      border-radius: 4px;
      font-size: 14px;
      cursor: pointer;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      gap: 5px;
    }

    .back-btn:hover {
      background-color: #d4a218;
    }

    .main-content {
      flex: 1;
      display: flex;
      justify-content: center;
      align-items: flex-start;
      padding: 40px 20px;
    }

    .form-container {
      background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
      border-radius: 12px;
      padding: 40px;
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
      border-left: 5px solid #FDB927;
      width: 100%;
      max-width: 800px;
      color: #333;
    }

    .form-header {
      text-align: center;
      margin-bottom: 30px;
    }

    .form-title {
      color: #FDB927;
      font-size: 28px;
      font-weight: bold;
      margin-bottom: 10px;
    }

    .form-subtitle {
      color: #666;
      font-size: 14px;
    }

    .patient-info {
      background-color: #f8f9fa;
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 30px;
      border-left: 4px solid #FDB927;
    }

    .patient-info h3 {
      color: #FDB927;
      margin-top: 0;
      margin-bottom: 15px;
    }

    .info-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }

    .info-item {
      display: flex;
      justify-content: space-between;
    }

    .info-label {
      font-weight: 600;
      color: #666;
    }

    .info-value {
      color: #333;
    }

    .upload-section {
      background-color: #f8f9fa;
      padding: 25px;
      border-radius: 8px;
      margin-bottom: 25px;
      border-left: 4px solid #FDB927;
    }

    .upload-section h3 {
      color: #FDB927;
      margin-top: 0;
      margin-bottom: 20px;
      text-align: center;
    }

    .form-group {
      margin-bottom: 20px;
    }

    .form-label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: #333;
      font-size: 14px;
    }

    .form-input {
      width: 100%;
      padding: 12px 16px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 16px;
      transition: border-color 0.3s ease;
      box-sizing: border-box;
    }

    .form-input:focus {
      outline: none;
      border-color: #FDB927;
      box-shadow: 0 0 0 3px rgba(253, 185, 39, 0.1);
    }

    .form-select {
      width: 100%;
      padding: 12px 16px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 16px;
      background-color: white;
      cursor: pointer;
      transition: border-color 0.3s ease;
      box-sizing: border-box;
    }

    .form-select:focus {
      outline: none;
      border-color: #FDB927;
      box-shadow: 0 0 0 3px rgba(253, 185, 39, 0.1);
    }

    .file-upload {
      border: 2px dashed #FDB927;
      border-radius: 8px;
      padding: 30px;
      text-align: center;
      background-color: #fff8e1;
      transition: all 0.3s ease;
    }

    .file-upload:hover {
      background-color: #fff3c4;
    }

    .file-upload input[type="file"] {
      display: none;
    }

    .file-upload-label {
      cursor: pointer;
      display: block;
      color: #FDB927;
      font-weight: 600;
      font-size: 16px;
    }

    .file-upload-icon {
      font-size: 48px;
      margin-bottom: 10px;
      display: block;
    }

    .form-buttons {
      display: flex;
      gap: 15px;
      margin-top: 30px;
    }

    .btn-primary {
      flex: 1;
      background: linear-gradient(135deg, #FDB927 0%, #d4a218 100%);
      color: #000000;
      font-weight: bold;
      padding: 14px 20px;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .btn-primary:hover {
      background: linear-gradient(135deg, #d4a218 0%, #b8941f 100%);
      transform: translateY(-2px);
      box-shadow: 0 4px 15px rgba(253, 185, 39, 0.3);
    }

    .btn-primary:disabled {
      background: #ccc;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }

    .btn-nihss {
      background: linear-gradient(135deg, #2196f3 0%, #1976d2 100%);
      color: #FFFFFF;
      font-weight: bold;
      padding: 14px 20px;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .btn-nihss:hover {
      background: linear-gradient(135deg, #1976d2 0%, #1565c0 100%);
      transform: translateY(-2px);
      box-shadow: 0 4px 15px rgba(33, 150, 243, 0.3);
    }

    .btn-secondary {
      background: #6c757d;
      color: white;
      font-weight: bold;
      padding: 14px 20px;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .btn-secondary:hover {
      background: #5a6268;
    }

    .success-message {
      background-color: #d4edda;
      color: #155724;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 20px;
      border-left: 4px solid #28a745;
    }

    .error-message {
      background-color: #f8d7da;
      color: #721c24;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 20px;
      border-left: 4px solid #dc3545;
    }

    .eligibility-result {
      padding: 20px;
      border-radius: 8px;
      margin-top: 20px;
      text-align: center;
      font-size: 18px;
      font-weight: bold;
    }

    .eligible {
      background-color: #d4edda;
      color: #155724;
      border-left: 4px solid #28a745;
    }

    .not-eligible {
      background-color: #f8d7da;
      color: #721c24;
      border-left: 4px solid #dc3545;
    }

    /* Patient Selection Table Styles */
    .patient-selection-container {
      background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
      border-radius: 12px;
      padding: 30px;
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
      border-left: 5px solid #FDB927;
      width: 100%;
      max-width: 1200px;
      color: #333;
      margin-bottom: 20px;
    }

    .patient-selection-header {
      text-align: center;
      margin-bottom: 30px;
    }

    .patient-selection-title {
      color: #FDB927;
      font-size: 28px;
      font-weight: bold;
      margin-bottom: 10px;
    }

    .patient-selection-subtitle {
      color: #666;
      font-size: 14px;
    }

    .search-controls {
      padding: 20px;
      background-color: #f8f9fa;
      border-radius: 8px;
      margin-bottom: 20px;
      display: flex;
      gap: 15px;
      align-items: center;
      flex-wrap: wrap;
    }

    .search-input {
      padding: 10px 15px;
      border: 2px solid #ddd;
      border-radius: 6px;
      font-size: 14px;
      background-color: #ffffff;
      color: #333;
      min-width: 300px;
      flex: 1;
    }

    .search-input:focus {
      outline: none;
      border-color: #FDB927;
      box-shadow: 0 0 3px rgba(253, 185, 39, 0.3);
    }

    .search-label {
      font-size: 14px;
      font-weight: 600;
      color: #333;
      margin-right: 5px;
    }

    .patient-table {
      width: 100%;
      border-collapse: collapse;
      background-color: #ffffff;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    }

    .patient-table th {
      background-color: #FDB927;
      color: #000000;
      font-weight: 600;
      padding: 15px 12px;
      text-align: left;
      font-size: 14px;
    }

    .patient-table td {
      padding: 12px;
      border-bottom: 1px solid #eee;
      vertical-align: top;
      color: #333;
      font-size: 14px;
    }

    .patient-table tr:hover {
      background-color: #f8f9fa;
      cursor: pointer;
    }

    .patient-table tr:last-child td {
      border-bottom: none;
    }

    .patient-code {
      font-family: monospace;
      background-color: #f8f9fa;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 12px;
      color: #333;
      font-weight: bold;
    }

    .no-patients {
      text-align: center;
      padding: 40px;
      color: #666;
      font-style: italic;
    }

    .hidden {
      display: none;
    }

    .loading {
      display: none;
      text-align: center;
      margin-top: 20px;
    }

    .spinner {
      border: 3px solid #f3f3f3;
      border-top: 3px solid #FDB927;
      border-radius: 50%;
      width: 30px;
      height: 30px;
      animation: spin 1s linear infinite;
      margin: 0 auto 10px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* Modal Styles */
    .modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.8);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }

    .modal-content {
      background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
      border-radius: 12px;
      padding: 40px;
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
      border-left: 5px solid #FDB927;
      max-width: 500px;
      width: 90%;
      text-align: center;
      color: #333;
    }

    .success-header h2 {
      color: #28a745;
      margin-bottom: 15px;
      font-size: 24px;
    }

    .success-header p {
      color: #666;
      margin-bottom: 30px;
    }

    .modal-buttons {
      display: flex;
      gap: 15px;
      justify-content: center;
    }

    /* Patient Summary Styles */
    .patient-summary {
      background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
      border-radius: 12px;
      padding: 30px;
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
      border-left: 5px solid #FDB927;
      color: #333;
      margin-top: 20px;
    }

    .summary-header {
      text-align: center;
      margin-bottom: 30px;
      border-bottom: 2px solid #FDB927;
      padding-bottom: 20px;
    }

    .summary-header h2 {
      color: #FDB927;
      font-size: 24px;
      margin-bottom: 10px;
    }

    .summary-header p {
      color: #666;
      font-size: 14px;
    }

    .summary-sections {
      display: grid;
      gap: 25px;
      margin-bottom: 30px;
    }

    .summary-section {
      background-color: #f8f9fa;
      padding: 20px;
      border-radius: 8px;
      border-left: 4px solid #FDB927;
    }

    .summary-section h3 {
      color: #FDB927;
      margin-top: 0;
      margin-bottom: 15px;
      font-size: 18px;
    }

    .nihss-summary {
      display: flex;
      flex-direction: column;
      gap: 15px;
    }

    .nihss-score {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background-color: #fff;
      padding: 15px;
      border-radius: 8px;
      border: 2px solid #FDB927;
    }

    .score-label {
      font-weight: 600;
      color: #333;
    }

    .score-value {
      font-size: 24px;
      font-weight: bold;
      color: #FDB927;
    }

    .nihss-details {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 10px;
    }

    .nihss-detail-item {
      background-color: #fff;
      padding: 10px;
      border-radius: 6px;
      border: 1px solid #e0e0e0;
      font-size: 14px;
    }

    .scan-summary {
      display: flex;
      flex-direction: column;
      gap: 15px;
    }

    .eligibility-result-summary {
      background-color: #fff;
      padding: 15px;
      border-radius: 8px;
      border: 2px solid #e0e0e0;
      text-align: center;
    }

    .eligibility-result-summary.eligible {
      border-color: #28a745;
      background-color: #d4edda;
    }

    .eligibility-result-summary.not-eligible {
      border-color: #dc3545;
      background-color: #f8d7da;
    }

    .notes-textarea {
      width: 100%;
      padding: 12px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 14px;
      font-family: inherit;
      resize: vertical;
      min-height: 100px;
      box-sizing: border-box;
    }

    .notes-textarea:focus {
      outline: none;
      border-color: #FDB927;
      box-shadow: 0 0 0 3px rgba(253, 185, 39, 0.1);
    }

    .summary-actions {
      display: flex;
      gap: 15px;
      justify-content: center;
      margin-top: 30px;
      padding-top: 20px;
      border-top: 2px solid #FDB927;
    }

    .btn-save {
      background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
      color: white;
      font-weight: bold;
      padding: 14px 20px;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .btn-save:hover {
      background: linear-gradient(135deg, #20c997 0%, #17a2b8 100%);
      transform: translateY(-2px);
      box-shadow: 0 4px 15px rgba(40, 167, 69, 0.3);
    }

    .btn-send {
      background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
      color: white;
      font-weight: bold;
      padding: 14px 20px;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .btn-send:hover {
      background: linear-gradient(135deg, #0056b3 0%, #004085 100%);
      transform: translateY(-2px);
      box-shadow: 0 4px 15px rgba(0, 123, 255, 0.3);
    }

    /* Responsive design */
    @media (max-width: 768px) {
      .form-container {
        padding: 30px 20px;
        margin: 20px;
      }

      .form-title {
        font-size: 24px;
      }

      .info-grid {
        grid-template-columns: 1fr;
      }

      .form-buttons {
        flex-direction: column;
      }

      .btn-primary,
      .btn-secondary {
        width: 100%;
      }
    }
  </style>
</head>
<body>
  <div class="header-bar">
    <div class="header-left">
      <div class="system-name">Stroke Detection System</div>
    </div>
    <div class="header-right">
      <a href="/technician-dashboard" class="back-btn">
        ← Back to Dashboard
      </a>
    </div>
  </div>

  <div class="main-content">
    <!-- Patient Selection Table -->
    <div class="patient-selection-container" id="patientSelectionContainer">
      <div class="patient-selection-header">
        <h1 class="patient-selection-title">👥 Select Patient for Scan Upload</h1>
        <p class="patient-selection-subtitle">Choose a patient to upload their scan and run tPA eligibility assessment</p>
      </div>

      <div class="search-controls">
        <span class="search-label">🔍 Search:</span>
        <input type="text" class="search-input" id="patientSearch" placeholder="Search by name, patient code, or chief complaint..." onkeyup="filterPatients()">
      </div>

      <div id="patientsTableContainer">
        <table class="patient-table" id="patientsTable">
          <thead>
            <tr>
              <th>Patient Code</th>
              <th>Name</th>
              <th>Age</th>
              <th>Gender</th>
              <th>Chief Complaint</th>
              <th>Time Since Onset</th>
              <th>NIHSS Score</th>
              <th>Scans</th>
            </tr>
          </thead>
          <tbody id="patientsTableBody">
            <!-- Patient data will be loaded here -->
          </tbody>
        </table>
        <div class="no-patients hidden" id="noPatientsMessage">
          No patients found matching your search criteria.
        </div>
      </div>
    </div>

    <!-- Upload Form (Hidden Initially) -->
    <div class="form-container hidden" id="uploadFormContainer">
      <div class="form-header">
        <h1 class="form-title">📤 Upload Scan & tPA Assessment</h1>
        <p class="form-subtitle">Upload CT/MRI scan and run tPA eligibility check</p>
        <button class="btn-secondary" onclick="backToPatientSelection()" style="margin-top: 15px;">
          ← Back to Patient Selection
        </button>
      </div>

      <div class="success-message">
        ✅ NIHSS assessment completed successfully!
      </div>

      <div class="patient-info" id="patientInfo">
        <h3>Patient Information</h3>
        <div class="info-grid">
          <div class="info-item">
            <span class="info-label">Patient Code:</span>
            <span class="info-value" id="patientCode">Loading...</span>
          </div>
          <div class="info-item">
            <span class="info-label">Name:</span>
            <span class="info-value" id="patientName">Loading...</span>
          </div>
          <div class="info-item">
            <span class="info-label">Age:</span>
            <span class="info-value" id="patientAge">Loading...</span>
          </div>
          <div class="info-item">
            <span class="info-label">Gender:</span>
            <span class="info-value" id="patientGender">Loading...</span>
          </div>
          <div class="info-item">
            <span class="info-label">Time Since Onset:</span>
            <span class="info-value" id="timeSinceOnset">Loading...</span>
          </div>
          <div class="info-item">
            <span class="info-label">NIHSS Score:</span>
            <span class="info-value" id="nihssScore">Loading...</span>
          </div>
        </div>
      </div>

      <form id="uploadForm">
        <div class="upload-section">
          <h3>Scan Upload & Imaging Confirmation</h3>
          
          <div class="form-group">
            <label for="scanType" class="form-label">Scan Type *</label>
            <select id="scanType" name="scanType" class="form-select" required>
              <option value="">Select Scan Type</option>
              <option value="CT">CT Scan</option>
              <option value="MRI">MRI Scan</option>
            </select>
          </div>

          <div class="form-group">
            <label for="imagingConfirmed" class="form-label">Imaging Confirmed: Ischemic Stroke? *</label>
            <select id="imagingConfirmed" name="imagingConfirmed" class="form-select" required>
              <option value="">Select Confirmation</option>
              <option value="yes">Yes - Ischemic stroke confirmed</option>
              <option value="no">No - Not confirmed</option>
            </select>
          </div>

          <div class="form-group">
            <label class="form-label">Upload CT/MRI Scan *</label>
            <div class="file-upload">
              <input type="file" id="scanFile" name="scanFile" accept="image/*" required>
              <label for="scanFile" class="file-upload-label">
                <span class="file-upload-icon">📁</span>
                Click to upload scan image
                <br>
                <small style="color: #666;">Supports: JPG, PNG, GIF</small>
              </label>
            </div>
          </div>
        </div>

        <div class="form-buttons">
          <button type="submit" class="btn-primary" id="submitBtn">
            Run tPA Eligibility Check
          </button>
          <button type="button" class="btn-nihss" onclick="goToNIHSSAssessment()">
            🧠 Calculate NIHSS Score
          </button>
          <button type="button" class="btn-secondary" onclick="goBack()">
            Cancel
          </button>
        </div>

        <div class="loading" id="loadingDiv">
          <div class="spinner"></div>
          <p>Processing scan and running tPA eligibility check...</p>
        </div>

        <div id="eligibilityResult" class="eligibility-result" style="display: none;">
          <!-- Results will be displayed here -->
        </div>
      </form>

      <!-- Upload Success Confirmation -->
      <div id="uploadSuccessModal" class="modal" style="display: none;">
        <div class="modal-content">
          <div class="success-header">
            <h2>✅ Upload Successful!</h2>
            <p>Scan has been uploaded and processed successfully.</p>
          </div>
          <div class="modal-buttons">
            <button class="btn-primary" onclick="showPatientSummary()">View Patient Summary</button>
            <button class="btn-secondary" onclick="goBack()">Return to Dashboard</button>
          </div>
        </div>
      </div>

      <!-- Patient Data Summary Screen -->
      <div id="patientSummary" class="patient-summary" style="display: none;">
        <div class="summary-header">
          <h2>📋 Complete Patient Assessment Summary</h2>
          <p>Review all collected data before saving or sending to doctor</p>
        </div>

        <div class="summary-sections">
          <!-- Patient Information -->
          <div class="summary-section">
            <h3>👤 Patient Information</h3>
            <div class="info-grid">
              <div class="info-item">
                <span class="info-label">Patient Code:</span>
                <span class="info-value" id="summaryPatientCode">-</span>
              </div>
              <div class="info-item">
                <span class="info-label">Name:</span>
                <span class="info-value" id="summaryPatientName">-</span>
              </div>
              <div class="info-item">
                <span class="info-label">Age:</span>
                <span class="info-value" id="summaryPatientAge">-</span>
              </div>
              <div class="info-item">
                <span class="info-label">Gender:</span>
                <span class="info-value" id="summaryPatientGender">-</span>
              </div>
            </div>
          </div>

          <!-- Vital Signs -->
          <div class="summary-section">
            <h3>🩺 Vital Signs</h3>
            <div class="info-grid">
              <div class="info-item">
                <span class="info-label">Blood Pressure:</span>
                <span class="info-value" id="summaryBP">-</span>
              </div>
              <div class="info-item">
                <span class="info-label">Heart Rate:</span>
                <span class="info-value" id="summaryHeartRate">-</span>
              </div>
              <div class="info-item">
                <span class="info-label">Temperature:</span>
                <span class="info-value" id="summaryTemperature">-</span>
              </div>
              <div class="info-item">
                <span class="info-label">Oxygen Saturation:</span>
                <span class="info-value" id="summaryOxygenSat">-</span>
              </div>
              <div class="info-item">
                <span class="info-label">Glucose:</span>
                <span class="info-value" id="summaryGlucose">-</span>
              </div>
              <div class="info-item">
                <span class="info-label">INR:</span>
                <span class="info-value" id="summaryINR">-</span>
              </div>
            </div>
          </div>

          <!-- NIHSS Assessment -->
          <div class="summary-section">
            <h3>🧠 NIHSS Assessment</h3>
            <div class="nihss-summary">
              <div class="nihss-score">
                <span class="score-label">Total NIHSS Score:</span>
                <span class="score-value" id="summaryNIHSSScore">-</span>
              </div>
              <div class="nihss-details" id="summaryNIHSSDetails">
                <!-- NIHSS details will be populated here -->
              </div>
            </div>
          </div>

          <!-- Scan & Eligibility -->
          <div class="summary-section">
            <h3>🔬 Scan Analysis & tPA Eligibility</h3>
            <div class="scan-summary">
              <div class="info-item">
                <span class="info-label">Scan Type:</span>
                <span class="info-value" id="summaryScanType">-</span>
              </div>
              <div class="info-item">
                <span class="info-label">Imaging Confirmed:</span>
                <span class="info-value" id="summaryImagingConfirmed">-</span>
              </div>
              <div class="eligibility-result-summary" id="summaryEligibilityResult">
                <!-- Eligibility result will be shown here -->
              </div>
            </div>
          </div>

          <!-- Technician Notes -->
          <div class="summary-section">
            <h3>📝 Technician Notes</h3>
            <textarea 
              id="technicianNotes" 
              class="notes-textarea" 
              placeholder="Enter any additional observations or notes (e.g., 'Patient restless during scan', 'Blood sample delayed', etc.)"
              rows="4"
            ></textarea>
          </div>
        </div>

        <!-- Action Buttons -->
        <div class="summary-actions">
          <button class="btn-save" onclick="saveRecord()">
            💾 Save Record
          </button>
          <button class="btn-send" onclick="sendToDoctor()">
            📤 Send to Doctor
          </button>
          <button class="btn-secondary" onclick="goBack()">
            Cancel
          </button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Global variables
    let allPatients = [];
    let selectedPatient = null;

    // Load all patients for selection
    async function loadAllPatients() {
      try {
        console.log('Loading patients...');
        const response = await fetch('/dashboard-details/total-patients');
        
        if (response.ok) {
          allPatients = await response.json();
          console.log('Loaded patients:', allPatients.length);
          displayPatients(allPatients);
        } else {
          console.error('Failed to load patients:', response.status, response.statusText);
          showError(`Failed to load patients (${response.status}). Please try again.`);
        }
      } catch (error) {
        console.error('Error loading patients:', error);
        showError('Error loading patients. Please check your connection and try again.');
      }
    }

    // Display patients in the table
    function displayPatients(patients) {
      console.log('Displaying patients:', patients);
      const tableBody = document.getElementById('patientsTableBody');
      const noPatientsMessage = document.getElementById('noPatientsMessage');
      
      if (!tableBody) {
        console.error('Table body element not found');
        return;
      }

      if (patients.length === 0) {
        console.log('No patients to display');
        tableBody.innerHTML = '';
        noPatientsMessage.classList.remove('hidden');
        return;
      }

      noPatientsMessage.classList.add('hidden');
      
      let html = '';
      patients.forEach(patient => {
        console.log('Processing patient:', patient);
        html += `
          <tr onclick="selectPatient('${patient.code}')">
            <td><span class="patient-code">${patient.code || 'N/A'}</span></td>
            <td>${patient.name || 'N/A'}</td>
            <td>${patient.age || 'N/A'}</td>
            <td>${patient.gender || 'N/A'}</td>
            <td>${patient.chief_complaint || 'N/A'}</td>
            <td>${patient.time_since_onset || 'Not Available'}</td>
            <td>${patient.nihss_score || 'Not Available'}</td>
            <td>${patient.scan_count || 0} scan(s)</td>
          </tr>
        `;
      });
      
      console.log('Generated HTML:', html);
      tableBody.innerHTML = html;
    }

    // Filter patients based on search
    function filterPatients() {
      const searchTerm = document.getElementById('patientSearch').value.toLowerCase();
      
      if (!searchTerm) {
        displayPatients(allPatients);
        return;
      }
      
      const filteredPatients = allPatients.filter(patient => {
        const searchableText = [
          patient.name || '',
          patient.code || '',
          patient.chief_complaint || '',
          patient.gender || '',
          patient.age?.toString() || ''
        ].join(' ').toLowerCase();
        
        return searchableText.includes(searchTerm);
      });
      
      displayPatients(filteredPatients);
    }

    // Select a patient and show upload form
    async function selectPatient(patientCode) {
      try {
        // Find the selected patient
        selectedPatient = allPatients.find(p => p.code === patientCode);
        
        if (!selectedPatient) {
          showError('Patient not found.');
          return;
        }

        // Load detailed patient information including NIHSS
        await loadPatientDetails(patientCode);
        
        // Hide patient selection and show upload form
        document.getElementById('patientSelectionContainer').classList.add('hidden');
        document.getElementById('uploadFormContainer').classList.remove('hidden');
        
      } catch (error) {
        console.error('Error selecting patient:', error);
        showError('Error loading patient details. Please try again.');
      }
    }

    // Load detailed patient information
    async function loadPatientDetails(patientCode) {
      try {
        // Load patient basic info
        const patientResponse = await fetch(`/api/patients/${patientCode}`);
        if (patientResponse.ok) {
          const patientData = await patientResponse.json();
          
          // Update patient info display
          document.getElementById('patientCode').textContent = patientData.code || 'N/A';
          document.getElementById('patientName').textContent = patientData.name || 'N/A';
          document.getElementById('patientAge').textContent = patientData.age || 'N/A';
          document.getElementById('patientGender').textContent = patientData.gender || 'N/A';
          document.getElementById('timeSinceOnset').textContent = patientData.time_since_onset || 'N/A';
        }

        // Load NIHSS assessment
        try {
          const nihssResponse = await fetch(`/api/patients/${patientCode}/nihss`);
          if (nihssResponse.ok) {
            const nihssData = await nihssResponse.json();
            document.getElementById('nihssScore').textContent = nihssData.total_score || 'N/A';
          } else {
            document.getElementById('nihssScore').textContent = 'Not Available';
          }
        } catch (nihssError) {
          console.log('NIHSS assessment not found for patient');
          document.getElementById('nihssScore').textContent = 'Not Available';
        }

      } catch (error) {
        console.error('Error loading patient details:', error);
        throw error;
      }
    }

    // Go back to patient selection
    function backToPatientSelection() {
      document.getElementById('uploadFormContainer').classList.add('hidden');
      document.getElementById('patientSelectionContainer').classList.remove('hidden');
      
      // Clear the form
      document.getElementById('uploadForm').reset();
      document.getElementById('fileInput').value = '';
      document.getElementById('filePreview').innerHTML = '';
      
      // Clear any messages
      clearMessages();
    }

    // Show error message
    function showError(message) {
      const errorDiv = document.createElement('div');
      errorDiv.className = 'error-message';
      errorDiv.textContent = message;
      
      const container = document.getElementById('patientSelectionContainer');
      const header = container.querySelector('.patient-selection-header');
      header.insertAdjacentElement('afterend', errorDiv);
      
      // Remove after 5 seconds
      setTimeout(() => {
        errorDiv.remove();
      }, 5000);
    }

    // Clear all messages
    function clearMessages() {
      const messages = document.querySelectorAll('.success-message, .error-message');
      messages.forEach(msg => msg.remove());
    }

    // Get patient code from URL parameters
    function getPatientCodeFromURL() {
      const urlParams = new URLSearchParams(window.location.search);
      return urlParams.get('patient');
    }

    // Load patient information (for direct access with patient code)
    async function loadPatientInfo() {
      const patientCode = getPatientCodeFromURL();
      
      if (!patientCode) {
        // No patient code in URL - show patient selection mode
        document.getElementById('patientSelectionContainer').classList.remove('hidden');
        document.getElementById('uploadFormContainer').classList.add('hidden');
        loadAllPatients();
        return;
      }

      try {
        const response = await fetch(`/api/patients/${patientCode}`);
        if (response.ok) {
          const patient = await response.json();
          
          // Update patient info display
          document.getElementById('patientCode').textContent = patient.code;
          document.getElementById('patientName').textContent = patient.name;
          document.getElementById('patientAge').textContent = patient.age;
          document.getElementById('patientGender').textContent = patient.gender;
          document.getElementById('timeSinceOnset').textContent = patient.time_since_onset;
          
          // Load NIHSS score
          const nihssResponse = await fetch(`/api/patients/${patientCode}/nihss`);
          if (nihssResponse.ok) {
            const nihssData = await nihssResponse.json();
            document.getElementById('nihssScore').textContent = nihssData.total_score || 'Not assessed';
          } else {
            document.getElementById('nihssScore').textContent = 'Not assessed';
          }
          
          // Show upload form directly since we have a patient code
          document.getElementById('patientSelectionContainer').classList.add('hidden');
          document.getElementById('uploadFormContainer').classList.remove('hidden');
          
        } else {
          throw new Error('Patient not found');
        }
      } catch (error) {
        console.error('Error loading patient:', error);
        alert('Error loading patient information. Redirecting to dashboard.');
        window.location.href = '/technician-dashboard';
      }
    }

    // Handle form submission
    document.getElementById('uploadForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      
      const patientCode = selectedPatient ? selectedPatient.code : getPatientCodeFromURL();
      if (!patientCode) {
        alert('No patient selected or available');
        return;
      }

      // Show loading state
      const submitBtn = document.getElementById('submitBtn');
      const loadingDiv = document.getElementById('loadingDiv');
      const eligibilityResult = document.getElementById('eligibilityResult');
      
      submitBtn.disabled = true;
      loadingDiv.style.display = 'block';
      eligibilityResult.style.display = 'none';

      try {
        // Prepare form data
        const formData = new FormData();
        formData.append('patient_code', patientCode);
        formData.append('scan_type', document.getElementById('scanType').value);
        formData.append('imaging_confirmed', document.getElementById('imagingConfirmed').value);
        formData.append('scan_file', document.getElementById('scanFile').files[0]);

        const response = await fetch('/api/upload-scan', {
          method: 'POST',
          body: formData
        });

        if (response.ok) {
          const result = await response.json();
          
          // Hide loading and show results
          loadingDiv.style.display = 'none';
          submitBtn.disabled = false;
          
          // Store the result for later use
          window.uploadResult = result;
          
          // Show upload success modal instead of immediate results
          document.getElementById('uploadSuccessModal').style.display = 'flex';
          
        } else {
          const errorData = await response.json();
          throw new Error(errorData.detail || 'Failed to process scan');
        }

      } catch (error) {
        console.error('Error processing scan:', error);
        
        // Hide loading and show error
        loadingDiv.style.display = 'none';
        submitBtn.disabled = false;
        
        // Show error message
        eligibilityResult.style.display = 'block';
        eligibilityResult.className = 'eligibility-result not-eligible';
        
        // Check if it's a NIHSS assessment error
        if (error.message && error.message.includes('NIHSS assessment not found')) {
          eligibilityResult.innerHTML = `
            <h3>🧠 NIHSS Assessment Required</h3>
            <p>NIHSS assessment not found for this patient. You need to calculate the NIHSS score before running tPA eligibility check.</p>
            <p><strong>Next Steps:</strong></p>
            <ol>
              <li>Click the "🧠 Calculate NIHSS Score" button below</li>
              <li>Complete the NIHSS assessment for this patient</li>
              <li>Return to this page to upload the scan</li>
            </ol>
            <p style="margin-top: 15px;">
              <button onclick="goToNIHSSAssessment()" style="background-color: #2196f3; color: white; padding: 10px 20px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold;">
                🧠 Go to NIHSS Assessment
              </button>
            </p>
          `;
        } else {
          eligibilityResult.innerHTML = `
            <h3>❌ Error</h3>
            <p>${error.message || 'Failed to process scan. Please try again.'}</p>
          `;
        }
      }
    });

    // Go back function
    function goBack() {
      if (confirm('Are you sure you want to cancel? Any uploaded data will be lost.')) {
        window.location.href = '/technician-dashboard';
      }
    }

    // Go to NIHSS Assessment function
    function goToNIHSSAssessment() {
      // Get patient code from either URL parameters or selected patient
      let patientCode = getPatientCodeFromURL();
      
      if (!patientCode && selectedPatient) {
        patientCode = selectedPatient.code;
      }
      
      if (!patientCode) {
        alert('No patient code available');
        return;
      }

      // Navigate to NIHSS assessment page with patient code
      window.location.href = `/nihss-assessment?patient=${patientCode}`;
    }

    // Show patient summary
    async function showPatientSummary() {
      // Get patient code from either URL parameters or selected patient
      let patientCode = getPatientCodeFromURL();
      
      if (!patientCode && selectedPatient) {
        patientCode = selectedPatient.code;
      }
      
      if (!patientCode) {
        alert('No patient code available');
        return;
      }

      try {
        // Hide the modal
        document.getElementById('uploadSuccessModal').style.display = 'none';
        
        // Show the patient summary
        document.getElementById('patientSummary').style.display = 'block';
        
        // Load and populate patient data
        await populatePatientSummary(patientCode);
        
      } catch (error) {
        console.error('Error showing patient summary:', error);
        alert('Error loading patient summary');
      }
    }

    // Populate patient summary with all data
    async function populatePatientSummary(patientCode) {
      try {
        // Get patient data
        const patientResponse = await fetch(`/api/patients/${patientCode}`);
        if (!patientResponse.ok) throw new Error('Patient not found');
        const patient = await patientResponse.json();
        
        // Get NIHSS data
        const nihssResponse = await fetch(`/api/patients/${patientCode}/nihss`);
        const nihssData = nihssResponse.ok ? await nihssResponse.json() : null;
        
        // Populate patient information
        document.getElementById('summaryPatientCode').textContent = patient.code;
        document.getElementById('summaryPatientName').textContent = patient.name;
        document.getElementById('summaryPatientAge').textContent = patient.age;
        document.getElementById('summaryPatientGender').textContent = patient.gender;
        
        // Populate vital signs
        document.getElementById('summaryBP').textContent = `${patient.systolic_bp || '-'}/${patient.diastolic_bp || '-'} mmHg`;
        document.getElementById('summaryHeartRate').textContent = `${patient.heart_rate || '-'} bpm`;
        document.getElementById('summaryTemperature').textContent = `${patient.temperature || '-'}°F`;
        document.getElementById('summaryOxygenSat').textContent = `${patient.oxygen_saturation || '-'}%`;
        document.getElementById('summaryGlucose').textContent = `${patient.glucose || '-'} mg/dL`;
        document.getElementById('summaryINR').textContent = patient.inr || '-';
        
        // Populate NIHSS assessment
        if (nihssData) {
          document.getElementById('summaryNIHSSScore').textContent = nihssData.total_score;
          
          // Create NIHSS details
          const nihssDetails = document.getElementById('summaryNIHSSDetails');
          nihssDetails.innerHTML = `
            <div class="nihss-detail-item"><strong>Consciousness:</strong> ${nihssData.consciousness}</div>
            <div class="nihss-detail-item"><strong>Gaze:</strong> ${nihssData.gaze}</div>
            <div class="nihss-detail-item"><strong>Visual:</strong> ${nihssData.visual}</div>
            <div class="nihss-detail-item"><strong>Facial:</strong> ${nihssData.facial}</div>
            <div class="nihss-detail-item"><strong>Motor Arm L:</strong> ${nihssData.motor_arm_left}</div>
            <div class="nihss-detail-item"><strong>Motor Arm R:</strong> ${nihssData.motor_arm_right}</div>
            <div class="nihss-detail-item"><strong>Motor Leg L:</strong> ${nihssData.motor_leg_left}</div>
            <div class="nihss-detail-item"><strong>Motor Leg R:</strong> ${nihssData.motor_leg_right}</div>
            <div class="nihss-detail-item"><strong>Ataxia:</strong> ${nihssData.ataxia}</div>
            <div class="nihss-detail-item"><strong>Sensory:</strong> ${nihssData.sensory}</div>
            <div class="nihss-detail-item"><strong>Language:</strong> ${nihssData.language}</div>
            <div class="nihss-detail-item"><strong>Dysarthria:</strong> ${nihssData.dysarthria}</div>
            <div class="nihss-detail-item"><strong>Extinction:</strong> ${nihssData.extinction}</div>
          `;
        } else {
          document.getElementById('summaryNIHSSScore').textContent = 'Not assessed';
          document.getElementById('summaryNIHSSDetails').innerHTML = '<p>NIHSS assessment not available</p>';
        }
        
        // Populate scan and eligibility data
        const scanType = document.getElementById('scanType')?.value || 'Not specified';
        const imagingConfirmed = document.getElementById('imagingConfirmed')?.value || 'Not specified';
        
        document.getElementById('summaryScanType').textContent = scanType;
        document.getElementById('summaryImagingConfirmed').textContent = imagingConfirmed === 'yes' ? 'Yes - Ischemic stroke confirmed' : 'No - Not confirmed';
        
        // Show eligibility result
        const eligibilityDiv = document.getElementById('summaryEligibilityResult');
        if (window.uploadResult) {
          eligibilityDiv.className = `eligibility-result-summary ${window.uploadResult.eligible ? 'eligible' : 'not-eligible'}`;
          
          if (window.uploadResult.eligible) {
            eligibilityDiv.innerHTML = `
              <h4>✅ ELIGIBLE FOR tPA</h4>
              <p>${window.uploadResult.reason}</p>
              <p><strong>Scan ID:</strong> ${window.uploadResult.scan_id}</p>
            `;
          } else {
            eligibilityDiv.innerHTML = `
              <h4>❌ NOT ELIGIBLE FOR tPA</h4>
              <p>${window.uploadResult.reason}</p>
              <p><strong>Scan ID:</strong> ${window.uploadResult.scan_id}</p>
            `;
          }
        } else {
          // If no upload result available, show a message
          eligibilityDiv.className = 'eligibility-result-summary';
          eligibilityDiv.innerHTML = '<p>Upload result not available</p>';
        }
        
      } catch (error) {
        console.error('Error populating patient summary:', error);
        alert('Error loading patient data');
      }
    }

    // Save record function
    async function saveRecord() {
      // Get patient code from either URL parameters or selected patient
      let patientCode = getPatientCodeFromURL();
      
      if (!patientCode && selectedPatient) {
        patientCode = selectedPatient.code;
      }
      
      const technicianNotes = document.getElementById('technicianNotes').value;
      
      if (!patientCode) {
        alert('No patient code available');
        return;
      }

      // Add confirmation dialog
      if (confirm('Are you sure you want to save this record? This will mark the case as "Saved" and store all current data.')) {
        try {
          const response = await fetch('/api/patients/save-record', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              patient_code: patientCode,
              technician_notes: technicianNotes,
              status: 'saved'
            })
          });

          if (response.ok) {
            alert('✅ Record saved successfully!\n\nAll patient data has been saved. You can continue working on this case or choose to exit when ready.');
            // Don't redirect - keep user on the page
          } else {
            throw new Error('Failed to save record');
          }
        } catch (error) {
          console.error('Error saving record:', error);
          alert('Error saving record. Please try again.');
        }
      }
    }

    // Send to doctor function
    async function sendToDoctor() {
      // Get patient code from either URL parameters or selected patient
      let patientCode = getPatientCodeFromURL();
      
      if (!patientCode && selectedPatient) {
        patientCode = selectedPatient.code;
      }
      
      const technicianNotes = document.getElementById('technicianNotes').value;
      
      if (!patientCode) {
        alert('No patient code available');
        return;
      }

      if (confirm('Are you sure you want to send this case to the doctor for review? This will mark it as "Ready for Doctor Review".')) {
        try {
          const response = await fetch('/api/patients/send-to-doctor', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              patient_code: patientCode,
              technician_notes: technicianNotes,
              status: 'ready_for_review'
            })
          });

          if (response.ok) {
            alert('✅ Case sent to doctor successfully!\n\nThis case has been marked as "Ready for Doctor Review" and will appear in the doctor\'s queue. You can continue working on other cases or choose to exit when ready.');
            // Don't redirect - keep user on the page
          } else {
            throw new Error('Failed to send to doctor');
          }
        } catch (error) {
          console.error('Error sending to doctor:', error);
          alert('Error sending case to doctor. Please try again.');
        }
      }
    }

    // Initialize page
    document.addEventListener('DOMContentLoaded', function() {
      loadPatientInfo();
    });
  </script>
</body>
</html>
