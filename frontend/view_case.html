<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>View Case - Stroke Detection System</title>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background-color: #000000;
      color: #FFFFFF;
      margin: 0;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      height: 100vh;
    }

    .header-bar {
      background-color: #F5F5DC; /* Cream background */
      border-bottom: 3px solid #FDB927; /* Gold bottom border */
      color: #000000; /* Dark text */
      padding: 15px 30px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      flex-wrap: wrap;
      gap: 15px;
    }

    .header-left {
      display: flex;
      align-items: center;
      gap: 20px;
    }

    .system-name {
      font-size: 24px;
      font-weight: bold;
      color: #000000;
    }

    .header-right {
      display: flex;
      align-items: center;
      gap: 15px;
    }

    .theme-toggle {
      background-color: #FDB927;
      color: #000000;
      font-weight: bold;
      padding: 8px 12px;
      border: none;
      border-radius: 6px;
      font-size: 12px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 5px;
    }

    .theme-toggle:hover {
      background-color: #d4a218;
    }

    .logout-btn {
      background-color: #FDB927;
      color: #000000;
      font-weight: bold;
      padding: 8px 16px;
      border: none;
      border-radius: 4px;
      font-size: 14px;
      cursor: pointer;
    }

    .logout-btn:hover {
      background-color: #d4a218;
    }

    /* Dark theme styles */
    body.dark-theme {
      background-color: #1a1a1a;
      color: #FFFFFF;
    }

    body.dark-theme .header-bar {
      background-color: #2d2d2d;
      color: #FFFFFF;
    }

    body.dark-theme .system-name {
      color: #FFFFFF;
    }

    .main-content {
      flex: 1;
      display: flex;
      justify-content: center;
      align-items: flex-start;
      padding: 20px;
      overflow-y: auto;
    }

    .case-container {
      width: 100%;
      max-width: 1200px;
      background-color: #FFFFFF;
      color: #000000;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      overflow: hidden;
    }

    .case-header {
      background-color: #FDB927;
      color: #000000;
      padding: 20px 30px;
      border-bottom: 3px solid #d4a218;
    }

    .case-title {
      font-size: 28px;
      font-weight: bold;
      margin: 0 0 10px 0;
    }

    .case-subtitle {
      font-size: 16px;
      opacity: 0.8;
      margin: 0;
    }

    .case-body {
      padding: 30px;
    }

    .section {
      margin-bottom: 40px;
      padding: 25px;
      background-color: #f8f9fa;
      border-radius: 8px;
      border-left: 5px solid #FDB927;
    }

    .section-title {
      font-size: 20px;
      font-weight: bold;
      color: #FDB927;
      margin: 0 0 20px 0;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .section-icon {
      font-size: 24px;
    }

    .info-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 20px;
    }

    .info-item {
      display: flex;
      flex-direction: column;
    }

    .info-label {
      font-weight: 600;
      color: #666;
      font-size: 14px;
      margin-bottom: 5px;
    }

    .info-value {
      font-size: 16px;
      color: #333;
      font-weight: 500;
    }

    .vitals-table {
      width: 100%;
      border-collapse: collapse;
      background-color: #FFFFFF;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    .vitals-table th {
      background-color: #FDB927;
      color: #000000;
      padding: 15px 12px;
      text-align: left;
      font-weight: bold;
      font-size: 14px;
    }

    .vitals-table td {
      padding: 12px;
      border-bottom: 1px solid #eee;
      font-size: 14px;
    }

    .vitals-table tr:hover {
      background-color: #f8f9fa;
    }

    .nihss-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin-bottom: 20px;
    }

    .nihss-item {
      background-color: #FFFFFF;
      padding: 15px;
      border-radius: 6px;
      border-left: 4px solid #FDB927;
    }

    .nihss-label {
      font-weight: 600;
      color: #666;
      font-size: 12px;
      margin-bottom: 5px;
    }

    .nihss-score {
      font-size: 24px;
      font-weight: bold;
      color: #FDB927;
    }

    .nihss-total {
      background-color: #FDB927;
      color: #000000;
      padding: 20px;
      border-radius: 8px;
      text-align: center;
      margin-top: 20px;
    }

    .nihss-total-score {
      font-size: 36px;
      font-weight: bold;
      margin-bottom: 10px;
    }

    .nihss-severity {
      font-size: 18px;
      font-weight: 600;
    }

    .scan-container {
      display: flex;
      gap: 30px;
      align-items: flex-start;
    }

    .scan-image {
      flex: 1;
      max-width: 400px;
    }

    .scan-image img {
      width: 100%;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    .scan-info {
      flex: 1;
    }

    .imaging-confirmed {
      display: inline-block;
      padding: 8px 16px;
      border-radius: 20px;
      font-weight: bold;
      font-size: 14px;
      margin-top: 10px;
    }

    .imaging-confirmed.yes {
      background-color: #4CAF50;
      color: white;
    }

    .imaging-confirmed.no {
      background-color: #F44336;
      color: white;
    }

    .eligibility-result {
      background-color: #FFFFFF;
      padding: 20px;
      border-radius: 8px;
      border-left: 5px solid #4CAF50;
    }

    .eligibility-result.not-eligible {
      border-left-color: #F44336;
    }

    .eligibility-status {
      font-size: 20px;
      font-weight: bold;
      margin-bottom: 10px;
    }

    .eligibility-status.eligible {
      color: #4CAF50;
    }

    .eligibility-status.not-eligible {
      color: #F44336;
    }

    .notes-textarea {
      width: 100%;
      min-height: 100px;
      padding: 15px;
      border: 2px solid #ddd;
      border-radius: 8px;
      font-size: 14px;
      font-family: inherit;
      resize: vertical;
    }

    .notes-textarea:focus {
      outline: none;
      border-color: #FDB927;
      box-shadow: 0 0 0 3px rgba(253, 185, 39, 0.2);
    }

    .readonly-textarea {
      background-color: #f8f9fa;
      color: #666;
      cursor: not-allowed;
    }

    .icd-search-container {
      position: relative;
      margin-bottom: 20px;
    }

    .icd-search-input {
      width: 100%;
      padding: 15px;
      border: 2px solid #ddd;
      border-radius: 8px;
      font-size: 16px;
    }

    .icd-search-input:focus {
      outline: none;
      border-color: #FDB927;
      box-shadow: 0 0 0 3px rgba(253, 185, 39, 0.2);
    }

    .icd-results {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background-color: #FFFFFF;
      border: 2px solid #ddd;
      border-top: none;
      border-radius: 0 0 8px 8px;
      max-height: 200px;
      overflow-y: auto;
      z-index: 1000;
      display: none;
    }

    .icd-result-item {
      padding: 12px 15px;
      cursor: pointer;
      border-bottom: 1px solid #eee;
    }

    .icd-result-item:hover {
      background-color: #f8f9fa;
    }

    .icd-code {
      font-weight: bold;
      color: #FDB927;
    }

    .icd-description {
      color: #666;
      font-size: 14px;
    }

    .icd-group-header {
      background-color: #FDB927;
      color: #000000;
      padding: 8px 15px;
      font-weight: bold;
      font-size: 13px;
      border-bottom: 1px solid #ddd;
      position: sticky;
      top: 0;
      z-index: 10;
    }

    .icd-loading {
      text-align: center;
      padding: 20px;
      color: #666;
      font-style: italic;
    }

    .icd-error {
      text-align: center;
      padding: 20px;
      color: #F44336;
      font-size: 14px;
    }

    .selected-diagnosis {
      background-color: #e8f5e8;
      padding: 15px;
      border-radius: 8px;
      border: 2px solid #4CAF50;
      margin-bottom: 20px;
    }

    .treatment-plan {
      width: 100%;
      min-height: 120px;
      padding: 15px;
      border: 2px solid #ddd;
      border-radius: 8px;
      font-size: 14px;
      font-family: inherit;
      resize: vertical;
    }

    .treatment-plan:focus {
      outline: none;
      border-color: #FDB927;
      box-shadow: 0 0 0 3px rgba(253, 185, 39, 0.2);
    }

    .button-group {
      display: flex;
      gap: 15px;
      justify-content: center;
      margin-top: 40px;
      padding-top: 30px;
      border-top: 2px solid #eee;
    }

    .btn {
      padding: 15px 30px;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.2s ease;
      min-width: 150px;
    }

    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
    }

    .btn-approve {
      background-color: #4CAF50;
      color: white;
    }

    .btn-approve:hover {
      background-color: #45a049;
    }

    .btn-reject {
      background-color: #F44336;
      color: white;
    }

    .btn-reject:hover {
      background-color: #da190b;
    }

    .btn-request-update {
      background-color: #FF9800;
      color: white;
    }

    .btn-request-update:hover {
      background-color: #e68900;
    }

    .btn-save {
      background-color: #FDB927;
      color: #000000;
    }

    .btn-save:hover {
      background-color: #d4a218;
    }

    .loading {
      text-align: center;
      padding: 40px;
      color: #666;
    }

    /* Toast Notification Styles */
    .toast-container {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 10000;
      max-width: 400px;
    }

    .toast {
      background-color: #333;
      color: white;
      padding: 16px 20px;
      border-radius: 8px;
      margin-bottom: 10px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
      transform: translateX(100%);
      transition: transform 0.3s ease-in-out;
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .toast.show {
      transform: translateX(0);
    }

    .toast.success {
      background-color: #4CAF50;
    }

    .toast.error {
      background-color: #F44336;
    }

    .toast.warning {
      background-color: #FF9800;
    }

    .toast.info {
      background-color: #2196F3;
    }

    .toast-icon {
      font-size: 20px;
      flex-shrink: 0;
    }

    .toast-message {
      flex: 1;
      font-size: 14px;
      line-height: 1.4;
    }

    .toast-close {
      background: none;
      border: none;
      color: white;
      font-size: 18px;
      cursor: pointer;
      padding: 0;
      margin-left: 8px;
      opacity: 0.7;
    }

    .toast-close:hover {
      opacity: 1;
    }

    /* Loading Spinner Styles */
    .spinner {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid rgba(255, 255, 255, 0.3);
      border-radius: 50%;
      border-top-color: #fff;
      animation: spin 1s ease-in-out infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .loading-spinner {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      padding: 20px;
      color: #666;
      font-style: italic;
    }

    .loading-spinner .spinner {
      border-color: rgba(102, 102, 102, 0.3);
      border-top-color: #666;
    }

    .error {
      background-color: #ffebee;
      color: #c62828;
      padding: 15px;
      border-radius: 8px;
      border-left: 5px solid #F44336;
      margin-bottom: 20px;
    }

    /* Dark theme for case content */
    body.dark-theme .case-container {
      background-color: #2d2d2d;
      color: #FFFFFF;
    }

    body.dark-theme .section {
      background-color: #3d3d3d;
    }

    body.dark-theme .info-label {
      color: #CCCCCC;
    }

    body.dark-theme .info-value {
      color: #FFFFFF;
    }

    body.dark-theme .vitals-table {
      background-color: #2d2d2d;
    }

    body.dark-theme .vitals-table td {
      color: #FFFFFF;
      border-bottom-color: #444;
    }

    body.dark-theme .vitals-table tr:hover {
      background-color: #3d3d3d;
    }

    body.dark-theme .nihss-item {
      background-color: #2d2d2d;
    }

    body.dark-theme .nihss-label {
      color: #CCCCCC;
    }

    body.dark-theme .eligibility-result {
      background-color: #2d2d2d;
    }

    body.dark-theme .notes-textarea,
    body.dark-theme .treatment-plan {
      background-color: #2d2d2d;
      color: #FFFFFF;
      border-color: #555;
    }

    body.dark-theme .icd-search-input {
      background-color: #2d2d2d;
      color: #FFFFFF;
      border-color: #555;
    }

    body.dark-theme .icd-results {
      background-color: #2d2d2d;
      border-color: #555;
    }

    body.dark-theme .icd-result-item {
      color: #FFFFFF;
      border-bottom-color: #444;
    }

    body.dark-theme .icd-result-item:hover {
      background-color: #3d3d3d;
    }

    body.dark-theme .icd-group-header {
      background-color: #FDB927;
      color: #000000;
      border-bottom-color: #555;
    }

    body.dark-theme .icd-loading {
      color: #CCCCCC;
    }

    body.dark-theme .icd-error {
      color: #FF6B6B;
    }

    body.dark-theme .selected-diagnosis {
      background-color: #1b5e20;
      border-color: #4CAF50;
      color: #FFFFFF;
    }

    body.dark-theme .readonly-textarea {
      background-color: #3d3d3d;
      color: #CCCCCC;
    }

    /* Dark theme for AI Treatment Generator */
    body.dark-theme .section .info-label {
      color: #CCCCCC;
    }

    body.dark-theme .section .info-value {
      color: #FFFFFF;
    }

    /* Dark theme for toast notifications */
    body.dark-theme .toast {
      background-color: #2d2d2d;
      color: #FFFFFF;
      border: 1px solid #444;
    }

    body.dark-theme .toast.success {
      background-color: #2e7d32;
    }

    body.dark-theme .toast.error {
      background-color: #c62828;
    }

    body.dark-theme .toast.warning {
      background-color: #ef6c00;
    }

    body.dark-theme .toast.info {
      background-color: #1565c0;
    }

    body.dark-theme .loading-spinner {
      color: #CCCCCC;
    }

    body.dark-theme .loading-spinner .spinner {
      border-color: rgba(204, 204, 204, 0.3);
      border-top-color: #CCCCCC;
    }
  </style>
</head>
<body>
  <div class="header-bar">
    <div class="header-left">
      <div class="system-name">Stroke Detection System</div>
    </div>
    
    <div class="header-right">
      <button class="theme-toggle" onclick="toggleTheme()" title="üåô Theme Toggle - Light/Dark comfort mode">
        üåô Theme
      </button>
      <button class="logout-btn" onclick="logout()">Logout</button>
    </div>
  </div>

  <div class="main-content">
    <div class="case-container">
      <div class="case-header">
        <h1 class="case-title">Case Review</h1>
        <p class="case-subtitle" id="caseSubtitle">Loading case details...</p>
      </div>
      
      <div class="case-body">
        <div id="loadingMessage" class="loading">
          <h3>Loading case details...</h3>
          <p>Please wait while we fetch the patient information.</p>
        </div>

        <div id="errorMessage" class="error" style="display: none;">
          <h3>Error Loading Case</h3>
          <p id="errorText">Unable to load case details. Please try again.</p>
        </div>

        <div id="caseContent" style="display: none;">
          <!-- Patient Info Section -->
          <div class="section">
            <h2 class="section-title">
              <span class="section-icon">üë§</span>
              Patient Information
            </h2>
            <div class="info-grid">
              <div class="info-item">
                <div class="info-label">Patient Name</div>
                <div class="info-value" id="patientName">-</div>
              </div>
              <div class="info-item">
                <div class="info-label">Age</div>
                <div class="info-value" id="patientAge">-</div>
              </div>
              <div class="info-item">
                <div class="info-label">Gender</div>
                <div class="info-value" id="patientGender">-</div>
              </div>
              <div class="info-item">
                <div class="info-label">Time Since Onset</div>
                <div class="info-value" id="timeSinceOnset">-</div>
              </div>
              <div class="info-item">
                <div class="info-label">Consent Status</div>
                <div class="info-value" id="consentStatus">-</div>
              </div>
              <div class="info-item">
                <div class="info-label">Chief Complaint</div>
                <div class="info-value" id="chiefComplaint">-</div>
              </div>
            </div>
          </div>

          <!-- Vitals Section -->
          <div class="section">
            <h2 class="section-title">
              <span class="section-icon">üíì</span>
              Vital Signs
            </h2>
            <table class="vitals-table">
              <thead>
                <tr>
                  <th>Parameter</th>
                  <th>Value</th>
                  <th>Unit</th>
                  <th>Status</th>
                </tr>
              </thead>
              <tbody id="vitalsTableBody">
                <tr><td colspan="4" style="text-align: center;">Loading vitals...</td></tr>
              </tbody>
            </table>
          </div>

          <!-- NIHSS Section -->
          <div class="section">
            <h2 class="section-title">
              <span class="section-icon">üß†</span>
              NIHSS Assessment
            </h2>
            <div class="nihss-grid" id="nihssGrid">
              <div class="loading">Loading NIHSS scores...</div>
            </div>
            <div class="nihss-total">
              <div class="nihss-total-score" id="nihssTotal">-</div>
              <div class="nihss-severity" id="nihssSeverity">-</div>
            </div>
          </div>

          <!-- Scan Section -->
          <div class="section">
            <h2 class="section-title">
              <span class="section-icon">üì∑</span>
              Imaging Scan
            </h2>
            <div class="scan-container">
              <div class="scan-image">
                <img id="scanImage" src="" alt="Brain scan image" style="display: none;">
                <div id="noImageMessage" style="text-align: center; padding: 40px; color: #666;">
                  No scan image available
                </div>
              </div>
              <div class="scan-info">
                <div class="info-item">
                  <div class="info-label">Scan File</div>
                  <div class="info-value" id="scanFileName">-</div>
                </div>
                <div class="info-item">
                  <div class="info-label">Upload Date</div>
                  <div class="info-value" id="scanUploadDate">-</div>
                </div>
                <div class="info-item">
                  <div class="info-label">Imaging Confirmed</div>
                  <div class="info-value">
                    <span class="imaging-confirmed" id="imagingConfirmed">-</span>
                  </div>
                </div>
                <div class="info-item">
                  <div class="info-label">Prediction</div>
                  <div class="info-value" id="scanPrediction">-</div>
                </div>
              </div>
            </div>
          </div>

          <!-- Eligibility Result Section -->
          <div class="section">
            <h2 class="section-title">
              <span class="section-icon">‚úÖ</span>
              Eligibility Assessment
            </h2>
            <div class="eligibility-result" id="eligibilityResult">
              <div class="eligibility-status" id="eligibilityStatus">-</div>
              <div class="info-value" id="eligibilityReason">-</div>
            </div>
          </div>

          <!-- Technician Notes Section -->
          <div class="section">
            <h2 class="section-title">
              <span class="section-icon">üìù</span>
              Technician Notes
            </h2>
            <textarea class="notes-textarea readonly-textarea" id="technicianNotes" readonly>-</textarea>
          </div>

          <!-- Doctor Comment Section -->
          <div class="section">
            <h2 class="section-title">
              <span class="section-icon">üí¨</span>
              Doctor Comment
            </h2>
            <textarea class="notes-textarea" id="doctorComment" placeholder="Enter your clinical assessment and recommendations..."></textarea>
            <button class="btn btn-save" onclick="saveDoctorComment()" style="margin-top: 15px;">Save Comment</button>
          </div>

          <!-- ICD-10 Diagnosis and Treatment Section -->
          <div class="section">
            <h2 class="section-title">
              <span class="section-icon">üè•</span>
              ICD-10 Diagnosis & Treatment Plan
            </h2>
            
            <div class="icd-search-container">
              <input type="text" class="icd-search-input" id="icdSearchInput" placeholder="Search ICD-10 codes (e.g., 'stroke', 'hemorrhage', 'infarction')" onkeyup="searchICD10(this.value)">
              <div class="icd-results" id="icdResults"></div>
            </div>

            <div id="selectedDiagnosisContainer" style="display: none;">
              <div class="selected-diagnosis">
                <div class="info-label">Selected Diagnosis</div>
                <div class="info-value" id="selectedDiagnosis">-</div>
              </div>
            </div>

            <div class="info-item" style="margin-bottom: 15px;">
              <div class="info-label">Treatment Plan</div>
              <textarea class="treatment-plan" id="treatmentPlan" placeholder="Enter detailed treatment plan, medications, follow-up instructions..."></textarea>
            </div>

            <button class="btn btn-save" onclick="saveDiagnosis()">Save Diagnosis & Treatment</button>
          </div>

          <!-- AI Treatment Generator Section -->
          <div class="section">
            <h2 class="section-title">
              <span class="section-icon">ü§ñ</span>
              AI Treatment Generator
            </h2>
            
            <div style="background-color: #e8f4fd; padding: 20px; border-radius: 8px; margin-bottom: 20px; border-left: 5px solid #2196F3;">
              <p style="margin: 0; color: #1976d2; font-size: 14px;">
                <strong>üí° AI-Powered Treatment Suggestions:</strong> Generate evidence-based treatment recommendations using ChatGPT AI based on patient data and scan results.
              </p>
            </div>
            
            <div style="margin-bottom: 20px;">
              <button id="generatePlanBtn" class="btn" style="background-color: #2196F3; color: white; margin-bottom: 15px;" onclick="generateAITreatmentPlan()">
                <span id="generateBtnText">üöÄ Generate AI Treatment Suggestion</span>
                <span id="generateBtnSpinner" class="spinner" style="display: none;"></span>
              </button>
              
              <div id="aiLoadingMessage" class="loading-spinner" style="display: none;">
                <div class="spinner"></div>
                <span>ü§ñ Generating AI treatment plan... Please wait.</span>
              </div>
            </div>
            
            <div class="info-item" style="margin-bottom: 15px;">
              <div class="info-label">AI-Generated Treatment Plan</div>
              <textarea id="treatmentPlan" class="treatment-plan" placeholder="AI-generated treatment plan will appear here. You can edit and modify as needed..."></textarea>
            </div>
            
            <button id="savePlanBtn" class="btn btn-save" onclick="saveAITreatmentPlan()" style="display: none;">
              üíæ Save Treatment Plan
            </button>
          </div>

          <!-- Decision Buttons -->
          <div class="button-group">
            <button class="btn btn-approve" onclick="makeDecision('approved_tpa')">
              ‚úÖ Approve tPA Treatment
            </button>
            <button class="btn btn-reject" onclick="makeDecision('rejected')">
              ‚ùå Reject Case
            </button>
            <button class="btn btn-request-update" onclick="makeDecision('sent_to_doctor')">
              üîÑ Request Update
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Toast Notification Container -->
  <div class="toast-container" id="toastContainer"></div>

  <script>
    let currentPatientCode = '';
    let currentScanId = null;
    let selectedICDCode = null;

    // Theme toggle functionality
    function toggleTheme() {
      document.body.classList.toggle('dark-theme');
      const isDark = document.body.classList.contains('dark-theme');
      localStorage.setItem('theme', isDark ? 'dark' : 'light');
      
      // Update theme button text
      const themeBtn = document.querySelector('.theme-toggle');
      themeBtn.innerHTML = isDark ? '‚òÄÔ∏è Theme' : 'üåô Theme';
    }

    // Load saved theme on page load
    document.addEventListener('DOMContentLoaded', function() {
      const savedTheme = localStorage.getItem('theme');
      if (savedTheme === 'dark') {
        document.body.classList.add('dark-theme');
        const themeBtn = document.querySelector('.theme-toggle');
        themeBtn.innerHTML = '‚òÄÔ∏è Theme';
      }
      
      // Get patient code from URL
      const urlParams = new URLSearchParams(window.location.search);
      currentPatientCode = urlParams.get('code');
      
      if (currentPatientCode) {
        loadCaseDetails();
      } else {
        showError('No patient code provided');
      }
      
      // Auto-search for "stroke" to show all stroke-related codes
      setTimeout(() => {
        const searchInput = document.getElementById('icdSearchInput');
        if (searchInput) {
          searchInput.value = 'stroke';
          searchICD10('stroke');
        }
      }, 1000);
    });

    // Logout functionality
    function logout() {
      if (confirm('Are you sure you want to logout?')) {
        fetch('/logout', { method: 'POST' })
          .then(() => {
            window.location.href = '/login-page';
          })
          .catch(() => {
            window.location.href = '/login-page';
          });
      }
    }

    // Load case details
    async function loadCaseDetails() {
      try {
        const response = await fetch(`/api/cases/${currentPatientCode}`);
        if (!response.ok) {
          throw new Error('Case not found');
        }
        
        const caseData = await response.json();
        
        // Populate the form
        populateCaseData(caseData);
        
        // Hide loading, show content
        document.getElementById('loadingMessage').style.display = 'none';
        document.getElementById('caseContent').style.display = 'block';
        
      } catch (error) {
        console.error('Error loading case details:', error);
        showError(error.message);
      }
    }

    // Populate case data
    function populateCaseData(caseData) {
      const patientData = caseData.patient;
      const scanData = caseData.scan;
      const nihssData = caseData.nihss;
      
      // Update header
      document.getElementById('caseSubtitle').textContent = `Patient ${patientData.code} - ${patientData.name}`;
      
      // Patient info
      document.getElementById('patientName').textContent = patientData.name || 'N/A';
      document.getElementById('patientAge').textContent = patientData.age ? `${patientData.age} years` : 'N/A';
      document.getElementById('patientGender').textContent = patientData.gender || 'N/A';
      document.getElementById('timeSinceOnset').textContent = patientData.time_since_onset || 'N/A';
      document.getElementById('consentStatus').textContent = 'Consented'; // Default assumption
      document.getElementById('chiefComplaint').textContent = patientData.chief_complaint || 'N/A';
      
      // Vitals
      populateVitalsTable(patientData);
      
      // NIHSS
      if (nihssData) {
        populateNIHSS(nihssData);
      } else {
        document.getElementById('nihssGrid').innerHTML = '<div style="text-align: center; color: #666;">NIHSS assessment not completed</div>';
        document.getElementById('nihssTotal').textContent = 'N/A';
        document.getElementById('nihssSeverity').textContent = 'Assessment Required';
      }
      
      // Scan data
      if (scanData) {
        currentScanId = scanData.id;
        
        // Scan image
        if (scanData.image_path) {
          document.getElementById('scanImage').src = scanData.image_path;
          document.getElementById('scanImage').style.display = 'block';
          document.getElementById('noImageMessage').style.display = 'none';
        }
        
        document.getElementById('scanFileName').textContent = scanData.image_path ? scanData.image_path.split('/').pop() : 'N/A';
        document.getElementById('scanUploadDate').textContent = scanData.timestamp || 'N/A';
        document.getElementById('scanPrediction').textContent = scanData.prediction || 'N/A';
        
        // Imaging confirmed
        const imagingConfirmed = document.getElementById('imagingConfirmed');
        imagingConfirmed.textContent = scanData.imaging_confirmed ? 'Confirmed' : 'Not Confirmed';
        imagingConfirmed.className = `imaging-confirmed ${scanData.imaging_confirmed ? 'yes' : 'no'}`;
        
        // Eligibility
        const eligibilityResult = document.getElementById('eligibilityResult');
        const eligibilityStatus = document.getElementById('eligibilityStatus');
        const eligibilityReason = document.getElementById('eligibilityReason');
        
        if (scanData.eligible) {
          eligibilityResult.className = 'eligibility-result';
          eligibilityStatus.textContent = '‚úÖ Eligible for tPA Treatment';
          eligibilityStatus.className = 'eligibility-status eligible';
          eligibilityReason.textContent = scanData.eligibility_result || 'Meets all criteria for tPA administration';
        } else {
          eligibilityResult.className = 'eligibility-result not-eligible';
          eligibilityStatus.textContent = '‚ùå Not Eligible for tPA Treatment';
          eligibilityStatus.className = 'eligibility-status not-eligible';
          eligibilityReason.textContent = scanData.eligibility_result || 'Does not meet criteria for tPA administration';
        }
        
        // Technician notes
        document.getElementById('technicianNotes').value = scanData.technician_notes || 'No notes provided';
        
        // Doctor comment
        document.getElementById('doctorComment').value = scanData.doctor_comment || '';
      } else {
        document.getElementById('scanFileName').textContent = 'No scan data available';
        document.getElementById('scanUploadDate').textContent = 'N/A';
        document.getElementById('scanPrediction').textContent = 'N/A';
        document.getElementById('imagingConfirmed').textContent = 'N/A';
        document.getElementById('imagingConfirmed').className = 'imaging-confirmed';
        document.getElementById('technicianNotes').value = 'No scan data available';
      }
    }

    // Populate vitals table
    function populateVitalsTable(patientData) {
      const vitals = [
        { name: 'Blood Pressure', value: `${patientData.systolic_bp || 'N/A'}/${patientData.diastolic_bp || 'N/A'}`, unit: 'mmHg', status: 'Normal' },
        { name: 'Heart Rate', value: patientData.heart_rate || 'N/A', unit: 'bpm', status: 'Normal' },
        { name: 'Oxygen Saturation', value: patientData.oxygen_saturation || 'N/A', unit: '%', status: 'Normal' },
        { name: 'Temperature', value: patientData.temperature || 'N/A', unit: '¬∞C', status: 'Normal' },
        { name: 'Glucose', value: patientData.glucose || 'N/A', unit: 'mg/dL', status: 'Normal' },
        { name: 'INR', value: patientData.inr || 'N/A', unit: '', status: 'Normal' },
        { name: 'Platelet Count', value: patientData.platelet_count || 'N/A', unit: '/ŒºL', status: 'Normal' }
      ];
      
      const tbody = document.getElementById('vitalsTableBody');
      tbody.innerHTML = vitals.map(vital => `
        <tr>
          <td>${vital.name}</td>
          <td>${vital.value}</td>
          <td>${vital.unit}</td>
          <td>${vital.status}</td>
        </tr>
      `).join('');
    }

    // Populate NIHSS scores
    function populateNIHSS(nihssData) {
      const nihssScores = [
        { label: 'Consciousness', score: nihssData.consciousness },
        { label: 'Gaze', score: nihssData.gaze },
        { label: 'Visual', score: nihssData.visual },
        { label: 'Facial', score: nihssData.facial },
        { label: 'Motor Arm Left', score: nihssData.motor_arm_left },
        { label: 'Motor Arm Right', score: nihssData.motor_arm_right },
        { label: 'Motor Leg Left', score: nihssData.motor_leg_left },
        { label: 'Motor Leg Right', score: nihssData.motor_leg_right },
        { label: 'Ataxia', score: nihssData.ataxia },
        { label: 'Sensory', score: nihssData.sensory },
        { label: 'Language', score: nihssData.language },
        { label: 'Dysarthria', score: nihssData.dysarthria },
        { label: 'Extinction', score: nihssData.extinction }
      ];
      
      const grid = document.getElementById('nihssGrid');
      grid.innerHTML = nihssScores.map(item => `
        <div class="nihss-item">
          <div class="nihss-label">${item.label}</div>
          <div class="nihss-score">${item.score}</div>
        </div>
      `).join('');
      
      // Total score and severity
      const total = nihssData.total_score || 0;
      document.getElementById('nihssTotal').textContent = total;
      
      let severity = '';
      if (total <= 4) severity = 'Minor Stroke';
      else if (total <= 15) severity = 'Moderate Stroke';
      else if (total <= 20) severity = 'Moderate to Severe Stroke';
      else severity = 'Severe Stroke';
      
      document.getElementById('nihssSeverity').textContent = severity;
    }

    // Show error message
    function showError(message) {
      document.getElementById('loadingMessage').style.display = 'none';
      document.getElementById('errorText').textContent = message;
      document.getElementById('errorMessage').style.display = 'block';
    }

    // ICD-10 search functionality using real NLM API
    async function searchICD10(query) {
      const resultsContainer = document.getElementById('icdResults');
      
      if (query.length < 2) {
        resultsContainer.style.display = 'none';
        return;
      }
      
      // Show loading state
      resultsContainer.innerHTML = '<div class="icd-loading">üîç Searching ICD-10 database...</div>';
      resultsContainer.style.display = 'block';
      
      try {
        // Use real NLM API
        const response = await fetch(
          `https://clinicaltables.nlm.nih.gov/api/icd10cm/v3/search?sf=code,name&terms=${encodeURIComponent(query)}`
        );
        
        if (!response.ok) {
          throw new Error('Failed to fetch ICD-10 data');
        }
        
        const data = await response.json();
        
        // data[1] = codes, data[2] = descriptions
        const codes = data[1];
        const descriptions = data[2];
        
        if (!codes || codes.length === 0) {
          resultsContainer.innerHTML = '<div class="icd-error">No ICD-10 codes found for this search term</div>';
          return;
        }
        
        // Combine both lists
        const results = codes.map((code, i) => ({
          code,
          desc: descriptions[i][0]
        }));
        
        // Group by first 3 digits of ICD code
        const groupedResults = {};
        results.forEach(result => {
          const prefix = result.code.substring(0, 3);
          if (!groupedResults[prefix]) {
            groupedResults[prefix] = [];
          }
          groupedResults[prefix].push(result);
        });
        
        // Create HTML with grouped results
        let html = '';
        Object.keys(groupedResults).sort().forEach(prefix => {
          const group = groupedResults[prefix];
          const groupTitle = getGroupTitle(prefix);
          
          html += `<div class="icd-group-header">${groupTitle} (${prefix} series)</div>`;
          group.forEach(result => {
            html += `
              <div class="icd-result-item" onclick="selectICDCode('${result.code}', '${result.desc.replace(/'/g, "\\'")}')">
                <div class="icd-code">${result.code}</div>
                <div class="icd-description">${result.desc}</div>
              </div>
            `;
          });
        });
        
        resultsContainer.innerHTML = html;
        
      } catch (error) {
        console.error('Error searching ICD-10:', error);
        resultsContainer.innerHTML = '<div class="icd-error">‚ö†Ô∏è Unable to connect to ICD-10 database. Using offline data...</div>';
        // Fallback to mock data if API fails
        setTimeout(() => {
          searchICD10Fallback(query);
        }, 1000);
      }
    }
    
    // Fallback function with comprehensive stroke codes
    function searchICD10Fallback(query) {
      const resultsContainer = document.getElementById('icdResults');
      
      // Comprehensive stroke-related ICD-10 codes
      const strokeCodes = [
        // Ischemic strokes (I63 series)
        { code: 'I63.0', description: 'Cerebral infarction due to thrombosis of precerebral arteries' },
        { code: 'I63.1', description: 'Cerebral infarction due to embolism of precerebral arteries' },
        { code: 'I63.2', description: 'Cerebral infarction due to unspecified occlusion or stenosis of precerebral arteries' },
        { code: 'I63.3', description: 'Cerebral infarction due to thrombosis of cerebral arteries' },
        { code: 'I63.4', description: 'Cerebral infarction due to embolism of cerebral arteries' },
        { code: 'I63.5', description: 'Cerebral infarction due to unspecified occlusion or stenosis of cerebral arteries' },
        { code: 'I63.6', description: 'Cerebral infarction due to cerebral venous thrombosis, nonpyogenic' },
        { code: 'I63.8', description: 'Other cerebral infarction' },
        { code: 'I63.9', description: 'Cerebral infarction, unspecified' },
        
        // Hemorrhagic strokes (I60-I62 series)
        { code: 'I60.0', description: 'Nontraumatic subarachnoid hemorrhage from carotid siphon and bifurcation' },
        { code: 'I60.1', description: 'Nontraumatic subarachnoid hemorrhage from middle cerebral artery' },
        { code: 'I60.2', description: 'Nontraumatic subarachnoid hemorrhage from anterior communicating artery' },
        { code: 'I60.3', description: 'Nontraumatic subarachnoid hemorrhage from posterior communicating artery' },
        { code: 'I60.4', description: 'Nontraumatic subarachnoid hemorrhage from basilar artery' },
        { code: 'I60.5', description: 'Nontraumatic subarachnoid hemorrhage from vertebral artery' },
        { code: 'I60.6', description: 'Nontraumatic subarachnoid hemorrhage from other intracranial arteries' },
        { code: 'I60.7', description: 'Nontraumatic subarachnoid hemorrhage from intracranial artery, unspecified' },
        { code: 'I60.8', description: 'Other nontraumatic subarachnoid hemorrhage' },
        { code: 'I60.9', description: 'Nontraumatic subarachnoid hemorrhage, unspecified' },
        
        { code: 'I61.0', description: 'Nontraumatic intracerebral hemorrhage in hemisphere, subcortical' },
        { code: 'I61.1', description: 'Nontraumatic intracerebral hemorrhage in hemisphere, cortical' },
        { code: 'I61.2', description: 'Nontraumatic intracerebral hemorrhage in hemisphere, unspecified' },
        { code: 'I61.3', description: 'Nontraumatic intracerebral hemorrhage in brain stem' },
        { code: 'I61.4', description: 'Nontraumatic intracerebral hemorrhage in cerebellum' },
        { code: 'I61.5', description: 'Nontraumatic intracerebral hemorrhage, intraventricular' },
        { code: 'I61.6', description: 'Nontraumatic intracerebral hemorrhage, multiple localized' },
        { code: 'I61.8', description: 'Other nontraumatic intracerebral hemorrhage' },
        { code: 'I61.9', description: 'Nontraumatic intracerebral hemorrhage, unspecified' },
        
        { code: 'I62.0', description: 'Nontraumatic subdural hemorrhage' },
        { code: 'I62.1', description: 'Nontraumatic extradural hemorrhage' },
        { code: 'I62.9', description: 'Nontraumatic intracranial hemorrhage, unspecified' },
        
        // Other stroke-related codes
        { code: 'I64', description: 'Stroke, not specified as hemorrhage or infarction' },
        { code: 'I65.0', description: 'Occlusion and stenosis of vertebral artery' },
        { code: 'I65.1', description: 'Occlusion and stenosis of basilar artery' },
        { code: 'I65.2', description: 'Occlusion and stenosis of carotid artery' },
        { code: 'I65.3', description: 'Occlusion and stenosis of multiple and bilateral precerebral arteries' },
        { code: 'I65.8', description: 'Occlusion and stenosis of other precerebral arteries' },
        { code: 'I65.9', description: 'Occlusion and stenosis of unspecified precerebral artery' },
        
        { code: 'I66.0', description: 'Occlusion and stenosis of middle cerebral artery' },
        { code: 'I66.1', description: 'Occlusion and stenosis of anterior cerebral artery' },
        { code: 'I66.2', description: 'Occlusion and stenosis of posterior cerebral artery' },
        { code: 'I66.3', description: 'Occlusion and stenosis of cerebellar arteries' },
        { code: 'I66.8', description: 'Occlusion and stenosis of other cerebral arteries' },
        { code: 'I66.9', description: 'Occlusion and stenosis of unspecified cerebral artery' },
        
        // TIA and related conditions
        { code: 'G45.0', description: 'Vertebro-basilar artery syndrome' },
        { code: 'G45.1', description: 'Carotid artery syndrome (hemispheric)' },
        { code: 'G45.2', description: 'Multiple and bilateral precerebral artery syndromes' },
        { code: 'G45.3', description: 'Amaurosis fugax' },
        { code: 'G45.4', description: 'Transient global amnesia' },
        { code: 'G45.8', description: 'Other transient cerebral ischemic attacks and related syndromes' },
        { code: 'G45.9', description: 'Transient cerebral ischemic attack, unspecified' },
        
        // Other cerebrovascular conditions
        { code: 'G93.1', description: 'Anoxic brain damage, not elsewhere classified' },
        { code: 'G93.4', description: 'Encephalopathy, unspecified' },
        { code: 'G93.5', description: 'Compression of brain' },
        { code: 'G93.6', description: 'Cerebral edema' },
        { code: 'G93.7', description: 'Reye syndrome' },
        { code: 'G93.8', description: 'Other specified disorders of brain' },
        { code: 'G93.9', description: 'Disorder of brain, unspecified' }
      ];
      
      // Filter results based on query
      const filteredResults = strokeCodes.filter(item => 
        item.description.toLowerCase().includes(query.toLowerCase()) ||
        item.code.toLowerCase().includes(query.toLowerCase())
      );
      
      if (filteredResults.length > 0) {
        // Group by first 3 digits of ICD code
        const groupedResults = {};
        filteredResults.forEach(result => {
          const prefix = result.code.substring(0, 3);
          if (!groupedResults[prefix]) {
            groupedResults[prefix] = [];
          }
          groupedResults[prefix].push(result);
        });
        
        // Create HTML with grouped results
        let html = '';
        Object.keys(groupedResults).sort().forEach(prefix => {
          const group = groupedResults[prefix];
          const groupTitle = getGroupTitle(prefix);
          
          html += `<div class="icd-group-header">${groupTitle} (${prefix} series)</div>`;
          group.forEach(result => {
            html += `
              <div class="icd-result-item" onclick="selectICDCode('${result.code}', '${result.description.replace(/'/g, "\\'")}')">
                <div class="icd-code">${result.code}</div>
                <div class="icd-description">${result.description}</div>
              </div>
            `;
          });
        });
        
        resultsContainer.innerHTML = html;
        resultsContainer.style.display = 'block';
      } else {
        resultsContainer.style.display = 'none';
      }
    }
    
    // Get group title for ICD prefix
    function getGroupTitle(prefix) {
      const groupTitles = {
        'I60': 'Subarachnoid Hemorrhage',
        'I61': 'Intracerebral Hemorrhage', 
        'I62': 'Other Intracranial Hemorrhage',
        'I63': 'Cerebral Infarction (Ischemic Stroke)',
        'I64': 'Stroke, Unspecified',
        'I65': 'Precerebral Artery Occlusion',
        'I66': 'Cerebral Artery Occlusion',
        'G45': 'Transient Ischemic Attack (TIA)',
        'G93': 'Other Brain Disorders'
      };
      return groupTitles[prefix] || `${prefix} Series`;
    }

    // Select ICD code
    function selectICDCode(code, description) {
      selectedICDCode = { code, description };
      document.getElementById('icdSearchInput').value = `${code} - ${description}`;
      document.getElementById('icdResults').style.display = 'none';
      
      document.getElementById('selectedDiagnosis').textContent = `${code} - ${description}`;
      document.getElementById('selectedDiagnosisContainer').style.display = 'block';
    }

    // Save doctor comment
    async function saveDoctorComment() {
      const comment = document.getElementById('doctorComment').value;
      
      if (!currentScanId) {
        alert('No scan ID available');
        return;
      }
      
      try {
        const formData = new FormData();
        formData.append('comment', comment);
        
        const response = await fetch(`/scans/${currentScanId}/comment`, {
          method: 'POST',
          body: formData
        });
        
        if (response.ok) {
          alert('Comment saved successfully');
        } else {
          alert('Failed to save comment');
        }
      } catch (error) {
        console.error('Error saving comment:', error);
        alert('Error saving comment');
      }
    }

    // Save diagnosis and treatment
    async function saveDiagnosis() {
      if (!selectedICDCode) {
        alert('Please select an ICD-10 diagnosis first');
        return;
      }
      
      const treatmentPlan = document.getElementById('treatmentPlan').value;
      
      if (!treatmentPlan.trim()) {
        alert('Please enter a treatment plan');
        return;
      }
      
      // This would be implemented with a backend endpoint
      alert('Diagnosis and treatment plan saved successfully');
    }

    // Make decision
    async function makeDecision(status) {
      if (!currentScanId) {
        alert('No scan ID available');
        return;
      }
      
      let confirmMessage = '';
      switch (status) {
        case 'approved_tpa':
          confirmMessage = 'Are you sure you want to approve tPA treatment for this patient?';
          break;
        case 'rejected':
          confirmMessage = 'Are you sure you want to reject this case?';
          break;
        case 'sent_to_doctor':
          confirmMessage = 'Are you sure you want to request an update for this case?';
          break;
      }
      
      if (!confirm(confirmMessage)) {
        return;
      }
      
      try {
        const response = await fetch(`/api/scans/${currentScanId}/decision`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            status: status,
            decision_made_by: 'physician'
          })
        });
        
        if (response.ok) {
          alert('Decision recorded successfully. Technician has been notified.');
          // Optionally redirect back to dashboard
          setTimeout(() => {
            window.location.href = '/physician-dashboard';
          }, 2000);
        } else {
          alert('Failed to record decision');
        }
      } catch (error) {
        console.error('Error making decision:', error);
        alert('Error recording decision');
      }
    }

    // Close ICD results when clicking outside
    document.addEventListener('click', function(event) {
      const icdContainer = document.querySelector('.icd-search-container');
      const icdResults = document.getElementById('icdResults');
      
      if (!icdContainer.contains(event.target)) {
        icdResults.style.display = 'none';
      }
    });

    // Toast Notification System
    function showToast(message, type = 'info', duration = 5000) {
      const toastContainer = document.getElementById('toastContainer');
      const toast = document.createElement('div');
      toast.className = `toast ${type}`;
      
      const icons = {
        success: '‚úÖ',
        error: '‚ùå',
        warning: '‚ö†Ô∏è',
        info: '‚ÑπÔ∏è'
      };
      
      toast.innerHTML = `
        <div class="toast-icon">${icons[type] || icons.info}</div>
        <div class="toast-message">${message}</div>
        <button class="toast-close" onclick="removeToast(this)">√ó</button>
      `;
      
      toastContainer.appendChild(toast);
      
      // Trigger animation
      setTimeout(() => toast.classList.add('show'), 100);
      
      // Auto-remove after duration
      setTimeout(() => removeToast(toast.querySelector('.toast-close')), duration);
    }
    
    function removeToast(closeBtn) {
      const toast = closeBtn.closest('.toast');
      if (toast) {
        toast.classList.remove('show');
        setTimeout(() => {
          if (toast.parentNode) {
            toast.parentNode.removeChild(toast);
          }
        }, 300);
      }
    }

    // AI Treatment Generator Functions
    async function generateAITreatmentPlan() {
      const generateBtn = document.getElementById('generatePlanBtn');
      const generateBtnText = document.getElementById('generateBtnText');
      const generateBtnSpinner = document.getElementById('generateBtnSpinner');
      const loadingMessage = document.getElementById('aiLoadingMessage');
      const saveBtn = document.getElementById('savePlanBtn');
      
      // Show loading state
      generateBtn.disabled = true;
      generateBtnText.style.display = 'none';
      generateBtnSpinner.style.display = 'inline-block';
      loadingMessage.style.display = 'flex';
      
      try {
        // Collect patient data from the page
        const patientData = collectPatientDataForAI();
        
        // Validate patient data
        if (!validatePatientData(patientData)) {
          throw new Error('Incomplete patient data. Please ensure all required information is available.');
        }
        
        showToast('Sending request to AI...', 'info', 2000);
        
        // Call the AI treatment generation endpoint
        const response = await fetch('/api/generate-treatment', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(patientData)
        });
        
        if (!response.ok) {
          const errorData = await response.json().catch(() => ({ detail: 'Unknown error occurred' }));
          throw new Error(errorData.detail || `HTTP ${response.status}: ${response.statusText}`);
        }
        
        const data = await response.json();
        
        if (data.treatment_plan) {
          // Display the generated treatment plan
          const treatmentPlanTextarea = document.getElementById('treatmentPlan');
          treatmentPlanTextarea.value = data.treatment_plan;
          
          // Show save button
          saveBtn.style.display = 'inline-block';
          
          // Show success toast
          showToast('AI treatment plan generated successfully!', 'success', 4000);
          
          // Hide loading message after a brief delay
          setTimeout(() => {
            loadingMessage.style.display = 'none';
          }, 1000);
          
        } else {
          throw new Error('No treatment plan received from AI service');
        }
        
      } catch (error) {
        console.error('Error generating AI treatment plan:', error);
        
        // Hide loading state
        loadingMessage.style.display = 'none';
        
        // Show error toast
        let errorMessage = 'Failed to generate treatment plan';
        
        if (error.message.includes('fetch')) {
          errorMessage = 'Network error. Please check your internet connection.';
        } else if (error.message.includes('timeout')) {
          errorMessage = 'Request timed out. Please try again.';
        } else if (error.message.includes('API key')) {
          errorMessage = 'AI service configuration error. Please contact support.';
        } else if (error.message) {
          errorMessage = error.message;
        }
        
        showToast(errorMessage, 'error', 6000);
        
      } finally {
        // Re-enable button
        generateBtn.disabled = false;
        generateBtnText.style.display = 'inline';
        generateBtnSpinner.style.display = 'none';
      }
    }
    
    function validatePatientData(patientData) {
      const requiredFields = ['name', 'age', 'nhiss_score', 'systolic_bp', 'diastolic_bp', 'glucose', 'oxygen_saturation', 'symptoms'];
      
      for (const field of requiredFields) {
        if (!patientData[field] || patientData[field] === 0) {
          console.warn(`Missing or invalid field: ${field}`, patientData[field]);
          return false;
        }
      }
      
      // Additional validation
      if (patientData.age < 1 || patientData.age > 120) {
        console.warn('Invalid age:', patientData.age);
        return false;
      }
      
      if (patientData.nhiss_score < 0 || patientData.nhiss_score > 42) {
        console.warn('Invalid NIHSS score:', patientData.nhiss_score);
        return false;
      }
      
      return true;
    }
    
    function collectPatientDataForAI() {
      // Extract patient data from the page elements
      const patientName = document.getElementById('patientName').textContent || 'Unknown Patient';
      const patientAge = parseInt(document.getElementById('patientAge').textContent) || 0;
      const chiefComplaint = document.getElementById('chiefComplaint').textContent || 'Not specified';
      
      // Extract NIHSS score
      const nihssTotal = document.getElementById('nihssTotal').textContent;
      const nhissScore = parseInt(nihssTotal) || 0;
      
      // Extract vitals from the table
      const vitalsRows = document.querySelectorAll('#vitalsTableBody tr');
      let systolicBp = 120, diastolicBp = 80, glucose = 100, oxygenSaturation = 98;
      
      vitalsRows.forEach(row => {
        const cells = row.querySelectorAll('td');
        if (cells.length >= 2) {
          const parameter = cells[0].textContent.toLowerCase();
          const value = cells[1].textContent;
          
          if (parameter.includes('blood pressure')) {
            const bpMatch = value.match(/(\d+)\/(\d+)/);
            if (bpMatch) {
              systolicBp = parseInt(bpMatch[1]);
              diastolicBp = parseInt(bpMatch[2]);
            }
          } else if (parameter.includes('glucose')) {
            const glucoseMatch = value.match(/(\d+)/);
            if (glucoseMatch) {
              glucose = parseInt(glucoseMatch[1]);
            }
          } else if (parameter.includes('oxygen saturation')) {
            const oxygenMatch = value.match(/(\d+)/);
            if (oxygenMatch) {
              oxygenSaturation = parseInt(oxygenMatch[1]);
            }
          }
        }
      });
      
      // Create symptoms description from available data
      const symptoms = [
        chiefComplaint,
        `NIHSS Score: ${nhissScore}`,
        `Blood Pressure: ${systolicBp}/${diastolicBp} mmHg`,
        `Glucose: ${glucose} mg/dL`,
        `Oxygen Saturation: ${oxygenSaturation}%`
      ].join('. ');
      
      return {
        name: patientName,
        age: patientAge,
        nhiss_score: nhissScore,
        systolic_bp: systolicBp,
        diastolic_bp: diastolicBp,
        glucose: glucose,
        oxygen_saturation: oxygenSaturation,
        symptoms: symptoms
      };
    }
    
    async function saveAITreatmentPlan() {
      const treatmentPlan = document.getElementById('treatmentPlan').value;
      const saveBtn = document.getElementById('savePlanBtn');
      
      if (!treatmentPlan.trim()) {
        showToast('Please generate a treatment plan first', 'warning', 4000);
        return;
      }
      
      if (!currentPatientCode) {
        showToast('No patient code available', 'error', 4000);
        return;
      }
      
      // Show loading state on save button
      const originalText = saveBtn.textContent;
      saveBtn.disabled = true;
      saveBtn.innerHTML = '<span class="spinner"></span> Saving...';
      
      try {
        showToast('Saving treatment plan...', 'info', 2000);
        
        // Use the existing diagnosis endpoint to save the treatment plan
        const response = await fetch(`/physician/cases/${currentPatientCode}/diagnosis`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            treatment_plan: treatmentPlan,
            diagnosis: selectedICDCode ? selectedICDCode.code : 'AI-Generated Treatment Plan',
            notes: 'AI-generated treatment plan'
          })
        });
        
        if (response.ok) {
          showToast('Treatment plan saved successfully!', 'success', 4000);
          saveBtn.style.display = 'none';
        } else {
          const errorData = await response.json().catch(() => ({ detail: 'Unknown error occurred' }));
          throw new Error(errorData.detail || `HTTP ${response.status}: ${response.statusText}`);
        }
        
      } catch (error) {
        console.error('Error saving treatment plan:', error);
        
        let errorMessage = 'Failed to save treatment plan';
        if (error.message.includes('fetch')) {
          errorMessage = 'Network error. Please check your connection.';
        } else if (error.message) {
          errorMessage = error.message;
        }
        
        showToast(errorMessage, 'error', 6000);
        
      } finally {
        // Restore button state
        saveBtn.disabled = false;
        saveBtn.innerHTML = originalText;
      }
    }
  </script>
</body>
</html>
